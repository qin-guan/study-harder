# Windows Malware

Malwares interact with an OS via API to execute code. Since we are focusing on Windows Malware, we will look at its API.

## Windows API

- Windows uses its own naming method to represent data types in the C programming language, and also uses Hungarian Notation for API function identifiers.

- Here are some examples:
| Type | Description |
| ----------- | ----------- |
| `WORD` 💭 | 16 bits unsigned^^ value <sub><sup>(2 bytes)</sub></sup> |
| `DWORD` 💭 | 32 bits unsigned^^ value <sub><sup>(4 bytes)</sub></sup> |
| `Handles` 💭 | A reference to an object, and should only be manipulated by the Windows API |
| `Long Pointer` 💭 | A pointer to another type |
| `Callback` 💭 | A function that will be called by the Windows API, eg. `CreateFile()` |

!!! note "Handles (?)"
    > items that has been opened by the OS
    * Can only store a handle for later use, and cannot perform arithmetic operations on it (?)
    

### Hungarian Notation  

- Something like Camel Case , looking at the function name will depict the code's purpose
- eg. `CreateFile` / `ReadFile` / `WriteFile` - it does what its name states

### :thought_balloon: Handles

- Handles are items that has been opened by the OS
- Handles are like pointers and point to a location in memory
- Can store handle for later use
- Cannot perform arithmetic operations on handles


## File API

### :thought_balloon: File System Functions

`CreateFile`

:   Can open existing files, pipes, streams & I/O devices

`ReadFile` / `WriteFile`

:  

    Used to read/write to files

    When called, the function will read the first n number of bytes of the file. When called again, the next n number of bytes of the file will be read.

`CreateFileMapping` / `MapViewOfFile`

:   

    Usually, when these two functions are called together, a file will be loaded in memory to be manipulated.
    
    `CreateFileMapping` 
        > Loads a file from disk to memory
        
    `MapViewOfFile` (?)
        > Returns a pointer to the base address of the mapping which is used to access the file. Pointer to the base address to read / write to the file and jump around the file easily.
        - 👍 very handy for parsing files 
    
## Windows Registry

- Used to store OS and program configuration info (eg. settings,drivers,user accounts etc...)
- Hierarchical database of info to improve performance (?)
- Malware uses this registry for persistence and configuration (?)
- 👍 Good source of **host-based indicator**

!!! note "Host-Based Indicators/Signatures"
    * Identified data on the victim's computer that show possible signs of infection by a malware/ presence of malware
    * Other indicators are Network Signatures, which are identified/identifiable data from the network's traffic that show traces that a malware is present
      
### Registry Terms

#### Key 
> Like a folder that can contain toher folders
> Root Keys and Sub Keys are both keys.

#### Root Key
> Registry divided into 5 top-level sections called root key/hives

💭 The Five Root Keys

![Five Root Keys from my Registry Editor](https://user-images.githubusercontent.com/103948042/197324450-9613f11b-0bf0-46cd-8bcb-d897f14a6cf9.png)

| Key | Description |
| ----------- | ----------- |
| HKEY_LOCAL_MACHINE (HKLM) | Stores settings which are global to the local machine |
| HKEY_CURRENT_USER (HKCU) | Stores settings specific to the current user |
| HKEY_CLASSES_ROOT | Stores information defining types |
| HKEY_CURRENT_CONFIG | Stores settings about current hardware configuration |
| HKEY_USERS | Defines settings for current user, new user, default user |

<sub><sup> yes, the names are all in caps.</sub></sup>

#### Sub Key
> Like a subfolder to the big folder, the root key

#### Value entry
> Ordered pair with a name and value (?)

#### Common Registry Functions 💭
`RegOpenKeyEx`

:  

    Opens registry for querying or editing
    
`RegSetValueEX` 

:  

    Adds a new value to the registry and sets its data
    
`RegGetValue` 

:  

    Returns the data for a value entry


#### Registry Tools

1. Regedit - for editing registry entries
2. Autoruns - parses registry to find entries that start applications upon booting the OS (?)
3. Regshot - (?)
  
## Networking API

- Programs uses socket (establish connection with remote connection) to listen & send data to the network
- Some common functions of the Networking API is as follows:
![Functions from the Networking API](https://user-images.githubusercontent.com/103948042/197324695-03da4e88-8328-4378-b249-d4d81f12e875.png)


- Network sniffers :thought_balloon:
  - The following code creates a undetected network sniffer :
  
  
`WSASocket()` / `socket()` 

:  

    WSA = Windows Socket API , either one of these two commands can be used to create a RAW Socket.
 
 `Bind()`

:  

    Binds socket to interface.
    Binding attaches the connection (which is the socket) to the victim's computer, linking the victim's computer and the attacker

 
 `WSAloctl()` / `ioctlsocket()`

:  

    Puts interface to promiscuous mode, meaning that the wired/wireless network interface controller passes all traffic it receives to the CPU rather thatn passing only the frames that the controller is intended to receive (?)
  

- WinINET API :thought_balloon:
  - higher level API that implements some higher level protocols
  - API used in malware means that the malware has relations to manipulating internet

 `InternetOpen`

:  

    Start/initliase a connection to Internet
  
 `InternetOpen URL`

:  

    Connect to a URL

  
 `URLDownloadToFileA`

:  

    Downloads a file from the internet
  
 `InternetReadFile`

:  

    Reads a file off the internet
 
   

- Downloaders :thought_balloon:
    * Downloading a file from the Internet consists of two steps:
    1. Download the file from the internet 
         `URLDownloadToFile()` 
    :  

        Downloads a file off the internet
  
    2. Execute the newly downloaded file
        `ShellExecute()` / `WinExec()` 
    :  

        💭 Executes a specified operation on a file 

     
  
## Process Manipulation
- Some malwares create new processes to hide from the user or bypass host-based firewalls.
- These malicious programs can also be set to a socket, allowing the attacker to execute a remote shell.
- A parent process can specify properties associated to its child process. 
-  
- Eg. A malware(disguised as Minecraft) is downloaded onto the victim's computer. While the "application" <sub><sup>(also known as the parent process)</sub></sup> is run, background processes <sub><sup>(also known as child process)</sub></sup> like deleting the victim computer's hard disk data are created and run. 


!!! note "Specification of child process characteristics (Windows) "
    * `CreateProcess` by the WIN32 API
    > Creates a new process. Has a parameter STARTUPINFO, which includes a handle that points to standard input/output/error messages
    * Specification is done through this `CreateProcess` function, which takes a pointer to a STARTUPINFO structure, and options of the structure selected to specify the properties of the child process
    
##Keyloggers
- Many bots & works uses this method of monitoring a user's key strokes to spy on them and collect information
- Two Common methods:
    1. Install a hook for keyboard events
        A hook is a mechanism that allows applications to intercept events (messages on the computer, mouse actions, keystrokes). The act of intercepting an event is a `hook procedure`. A `hook procedure` can act on what it receives, choosing to modify or discard the event. 
        
        API Function for this:
        `SetWindowsHookExA` 
        : 
            
            If called with WH_KEYBOARD, event is relayed to a malicious function based on what key is pressed at any moment after the function is called.
            If called with WH_MOUSE, mouse messages like left-click or right-click will be intercepted.
            
    2. Poll keyboard state with `GetAsyncKeyState()`
        Malware goes in a loop and queries the state of every key. This is done via the `GetAsyncKeyState` to get the state of any specific key that is currently pressed.
    

!!! tip "Anand's tip corner"

    * If you want to know more details on certain functions, refer to the documentation
      * One useful link he showed! : [MSDN library](https://learn.microsoft.com/en-us/)
    * Using third party, should also check for security ^
